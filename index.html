<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Campo Express</title>
    <link rel="stylesheet" href="css/styles.css">
  <!-- Favicon and manifest -->
  <link rel="apple-touch-icon" href="css/campoExpress.png">
  <link rel="icon" type="image/png" href="css/campoExpress.png">
  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#2F9E44">
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
        <div class="container nav-inner">
        <a class="brand" href="#">Campo Express</a>
        <nav class="nav-links">
          <a href="#nosotros">Nosotros</a>
          <a href="#modelo-de-negocio">Modelo de Negocio</a>
          <button class="btn btn-primary" id="btn-access">Acceder</button>
        </nav>
        <button class="nav-toggle" aria-label="Abrir menú">☰</button>
      </div>
    </header>

    <!-- Hero -->
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-text">
          <h1>Frutas y verduras frescas, directo a tu puerta</h1>
          <p>Seleccionamos lo mejor del día para que disfrutes productos frescos, locales y saludables.</p>
        </div>
        <div class="hero-visual">
          <img src="css/campoExpress.png" alt="Frutas y verduras frescas de Campo Express">
        </div>
      </div>
    </section>

    <!-- Productos -->
    <main class="container">
      <section id="productos" class="products">
        <h2>Nuestras Tiendas</h2>
        <p class="lead" id="productos-lead">Elige las tiendas mas cercanas</p>
        <div class="grid" id="tiendas-grid">
        </div>
      </section>

      <!-- Panel de productos para fruvers -->
      <section id="fruver-panel" class="products" style="display:none;">
        <h2>Mis Productos</h2>
        <div class="fruver-content">
          <div class="agregar-producto">
            <h3>Agregar nuevo producto</h3>
            <form id="form-producto">
              <div class="form-group">
                <label for="prod-nombre">Nombre del producto</label>
                <input id="prod-nombre" type="text" placeholder="Ej: Manzana roja" required>
              </div>
              <div class="form-group">
                <label for="prod-cantidad">Cantidad disponible</label>
                <input id="prod-cantidad" type="number" placeholder="Ej: 50" min="1" required>
              </div>
              <div class="form-group">
                <label for="prod-precio">Precio por kg</label>
                <input id="prod-precio" type="number" placeholder="Ej: 2.50" step="0.01" min="0.01" required>
              </div>
              <div class="form-group">
                <label for="prod-imagen">Imagen del producto</label>
                <input id="prod-imagen" type="file" accept="image/*" required>
              </div>
              <button class="btn btn-primary" type="submit">Agregar producto</button>
            </form>
          </div>
          <div class="lista-productos">
            <h3>Productos disponibles</h3>
            <div id="productos-list" class="grid">
            </div>
          </div>
        </div>
      </section>

      <!-- Sección Nosotros -->
      <section id="nosotros" class="about">
        <h2>Nosotros</h2>
        <p>Campo Express es una plataforma que conecta fruvers con consumidores que buscan productos frescos y de calidad.</p>
      </section>

      <!-- Modelo de Negocio -->
      <section id="modelo-de-negocio" class="model">
        <h2>Modelo de Negocio</h2>
        <div class="model-inner">
          <img src="css/modeloCanvas.jpg" alt="Diagrama del modelo de negocio" class="zoomable">
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer id="contacto" class="site-footer">
      <div class="container footer-inner">
        <div class="footer-col">
          <h3>Campo Express</h3>
          <p>Frutas y verduras frescas, seleccionadas con cariño.</p>
        </div>
        <div class="footer-col">
          <h4>Contacto</h4>
          <p>Email: contacto@campoexpress.com</p>
          
        </div>
      </div>
      <div class="footer-bottom">
        <div class="container">© 2025 Campo Express — </div>
      </div>
    </footer>

    <div class="image-modal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
      <button class="image-modal__close" aria-label="Cerrar imagen">&times;</button>
      <img src="" alt="">
      <div class="close-hint">Presiona Esc o clic fuera para cerrar</div>
    </div>

    <!-- Modal de autenticación (login / registro) -->
    <div class="auth-modal" aria-hidden="true" role="dialog" aria-label="Autenticación">
      <div class="auth-panel" role="document">
        <button class="auth-close" aria-label="Cerrar">&times;</button>
        <div class="auth-tabs">
          <button class="auth-tab active" data-target="login">Iniciar sesión</button>
          <button class="auth-tab" data-target="register">Registrarse</button>
        </div>
        <div class="auth-body">
          <form id="login-form" class="auth-form active">
            <label for="login-email">Correo</label>
            <input id="login-email" name="email" type="email" required>
            <label for="login-pass">Contraseña</label>
            <input id="login-pass" name="password" type="password" required>
            <button class="btn btn-primary" type="submit">Entrar</button>
          </form>

          <form id="register-form" class="auth-form">
            <label for="reg-email">Correo</label>
            <input id="reg-email" name="email" type="email" required>
            <label for="reg-pass">Contraseña</label>
            <input id="reg-pass" name="password" type="password" required>
            <label for="reg-role">Rol</label>
            <select id="reg-role" name="role" required>
              <option value="">-- Selecciona rol --</option>
              <option value="fruver">Fruver</option>
              <option value="cliente">Cliente</option>
            </select>
            <label for="reg-barrio">Barrio</label>
            <select id="reg-barrio" name="barrio" required>
              <option value="">-- Selecciona barrio --</option>
              <option value="cabecera">Cabecera</option>
              <option value="provenza">Provenza</option>
              <option value="san-alonso">San Alonso</option>
            </select>
            <label for="reg-direccion">Dirección</label>
            <input id="reg-direccion" name="direccion" type="text" placeholder="Calle, número y referencias" required>
            <button class="btn btn-primary" type="submit">Crear cuenta</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Simple toggle para menú móvil
      const toggle = document.querySelector('.nav-toggle');
      const navLinks = document.querySelector('.nav-links');
      toggle?.addEventListener('click', ()=>{
        navLinks?.classList.toggle('open');
      });

      // Imagen zoomable -> modal fullscreen
      (function(){
        const zoomables = document.querySelectorAll('.zoomable');
        const modal = document.querySelector('.image-modal');
        if(!modal) return;
        const modalImg = modal.querySelector('img');
        const closeBtn = modal.querySelector('.image-modal__close');

        function openModal(src, alt){
          modalImg.src = src;
          modalImg.alt = alt || '';
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
          document.documentElement.classList.add('no-scroll');
          document.body.classList.add('no-scroll');
          closeBtn.focus();
        }

        function closeModal(){
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden','true');
          modalImg.src = '';
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }

        zoomables.forEach(img=>{
          img.addEventListener('click', ()=>{
            openModal(img.getAttribute('src') || img.dataset.src, img.getAttribute('alt'));
          });
        });

        // Close on click outside image or on close button
        modal.addEventListener('click', (e)=>{
          if(e.target === modal || e.target === closeBtn) closeModal();
        });

        // Avoid closing when clicking the image itself
        modal.querySelector('img')?.addEventListener('click', (e)=>e.stopPropagation());

        // Close on Escape
        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape' && modal.classList.contains('open')) closeModal();
        });
      })();

      // Modal de autenticación (login / register)
      (function(){
        const accessBtn = document.getElementById('btn-access');
        const authModal = document.querySelector('.auth-modal');
        const authPanel = authModal?.querySelector('.auth-panel');
        const closeBtn = authModal?.querySelector('.auth-close');
        const tabs = authModal?.querySelectorAll('.auth-tab');
        const forms = authModal?.querySelectorAll('.auth-form');

        if(!accessBtn || !authModal) return;

        function openAuth(target){
          // show modal and select tab
          authModal.classList.add('open');
          authModal.setAttribute('aria-hidden','false');
          document.documentElement.classList.add('no-scroll');
          document.body.classList.add('no-scroll');
          // set tab
          selectTab(target || 'login');
          // focus first input
          setTimeout(()=>{
            const first = authModal.querySelector('.auth-form.active input');
            first?.focus();
          }, 50);
        }

        function closeAuth(){
          authModal.classList.remove('open');
          authModal.setAttribute('aria-hidden','true');
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }

        function selectTab(name){
          tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===name));
          forms.forEach(f=>f.classList.toggle('active', f.id === (name==='login' ? 'login-form' : 'register-form')));
        }

        accessBtn.addEventListener('click', ()=>openAuth('login'));

        // tab clicks
        tabs.forEach(t=>t.addEventListener('click', ()=>selectTab(t.dataset.target)));

        // close handlers
        closeBtn?.addEventListener('click', closeAuth);
        authModal.addEventListener('click', (e)=>{ if(e.target === authModal) closeAuth(); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && authModal.classList.contains('open')) closeAuth(); });

        // Real auth logic (client-side demo using localStorage)
        const USERS_KEY = 'campo_users_v1';
        const SESSION_KEY = 'campo_current_user_v1';
        const TIENDAS_KEY = 'campo_tiendas_v1';

        // Base de datos de tiendas por barrio (inicial)
        let TIENDAS_POR_BARRIO = {
          'cabecera': [],
          'provenza': [],
          'san-alonso': []
        };

        function loadUsers(){
          try{ return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); }catch(e){ return {}; }
        }
        function saveUsers(obj){ localStorage.setItem(USERS_KEY, JSON.stringify(obj)); }

        function loadTiendas(){
          try{ 
            const stored = JSON.parse(localStorage.getItem(TIENDAS_KEY) || '{}');
            TIENDAS_POR_BARRIO = { ...TIENDAS_POR_BARRIO, ...stored };
          } catch(e){ }
        }

        function saveTiendas(){
          localStorage.setItem(TIENDAS_KEY, JSON.stringify(TIENDAS_POR_BARRIO));
        }

        // Cargar tiendas al inicializar
        loadTiendas();

        function renderTiendas(barrio){
          const grid = document.getElementById('tiendas-grid');
          const lead = document.getElementById('productos-lead');
          if(!grid) return;
          const tiendas = TIENDAS_POR_BARRIO[barrio] || [];
          if(tiendas.length > 0){
            lead.textContent = `Tiendas disponibles en ${barrio.charAt(0).toUpperCase() + barrio.slice(1)}`;
            grid.innerHTML = tiendas.map(t=>`
              <article class="card">
                <img src="${t.imagen}" alt="${t.nombre}">
                <div class="card-body">
                  <h3>${t.nombre}</h3>
                  <p>${t.descripcion}</p>
                  <div class="card-foot">
                    <span class="price">Tienda</span>
                  </div>
                </div>
              </article>
            `).join('');
          } else {
            lead.textContent = 'No hay tiendas cercanas en tu barrio.';
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--muted);"><p>Lo sentimos, aún no tenemos tiendas disponibles en tu área. Pronto llegará a tu barrio.</p></div>';
          }
        }

        async function hashPassword(password){
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest('SHA-256', enc.encode(password));
          return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        function setCurrentUser(key){
          localStorage.setItem(SESSION_KEY, key);
          const users = loadUsers();
          const user = users[key];
          if(user){
            if(user.role === 'fruver'){
              // Mostrar panel de fruver
              renderFruverPanel(key);
            } else if(user.barrio){
              // Mostrar tiendas para cliente
              renderTiendas(user.barrio);
            }
          }
          renderUserState();
        }

        function clearCurrentUser(){
          localStorage.removeItem(SESSION_KEY);
          renderUserState();
        }

        function renderFruverPanel(email){
          const tiendas = document.getElementById('productos');
          const panel = document.getElementById('fruver-panel');
          const tiendas_grid = document.getElementById('tiendas-grid');
          const productos_lead = document.getElementById('productos-lead');
          
          if(tiendas) tiendas.style.display = 'none';
          if(panel) panel.style.display = 'block';
          
          // Cargar y mostrar productos del fruver
          const PRODUCTOS_KEY = `campo_productos_${email}`;
          let productos = [];
          try{
            productos = JSON.parse(localStorage.getItem(PRODUCTOS_KEY) || '[]');
          } catch(e){ }
          
          const productosLista = document.getElementById('productos-list');
          if(productosLista){
            if(productos.length === 0){
              productosLista.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--muted);">No tienes productos aún. Agrega uno nuevo.</p>';
            } else {
              productosLista.innerHTML = productos.map((p, idx)=>`
                <article class="card">
                  ${p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}" style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius);">` : ''}
                  <div class="card-body">
                    <h3>${p.nombre}</h3>
                    <p><strong>Cantidad:</strong> ${p.cantidad} kg</p>
                    <p><strong>Precio:</strong> $${parseFloat(p.precio).toFixed(2)} / kg</p>
                    <div class="card-foot">
                      <button class="btn btn-outline btn-delete" data-idx="${idx}">Eliminar</button>
                    </div>
                  </div>
                </article>
              `).join('');
              // Agregar event listeners para eliminar
              productosLista.querySelectorAll('.btn-delete').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                  const idx = parseInt(btn.dataset.idx);
                  productos.splice(idx, 1);
                  localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
                  renderFruverPanel(email);
                });
              });
            }
          }
        }

        function clearCurrentUser(){
          localStorage.removeItem(SESSION_KEY);
          renderUserState();
        }

        function renderUserState(){
          const cur = localStorage.getItem(SESSION_KEY);
          const nav = document.querySelector('.nav-links');
          if(!nav) return;
          // remove existing user UI
          const existingLogout = document.getElementById('btn-logout');
          const existingUser = document.querySelector('.nav-user');
          if(existingLogout) existingLogout.remove();
          if(existingUser) existingUser.remove();
          // ensure access button exists
          let access = document.getElementById('btn-access');
          if(!access){
            access = document.createElement('button');
            access.className = 'btn btn-primary';
            access.id = 'btn-access';
            access.textContent = 'Acceder';
            nav.appendChild(access);
            access.addEventListener('click', ()=>openAuth('login'));
          }

          if(cur){
            const users = loadUsers();
            const user = users[cur];
            if(user){
              // replace access with greeting + logout
              access.remove();
              const span = document.createElement('span');
              span.className = 'nav-user';
              const display = (user.email || '').split('@')[0] || user.email;
              const direccionText = user.direccion ? ` - ${user.barrio || ''} - ${user.direccion}` : '';
              span.textContent = `Hola, ${display}${direccionText}`;
              nav.appendChild(span);
              const out = document.createElement('button');
              out.className = 'btn btn-outline';
              out.id = 'btn-logout';
              out.textContent = 'Cerrar sesión';
              nav.appendChild(out);
              out.addEventListener('click', ()=>{ clearCurrentUser(); });
            }
          } else {
            // Sin sesión: mostrar mensaje en productos y ocultar panel fruver
            const tiendas = document.getElementById('productos');
            const panel = document.getElementById('fruver-panel');
            if(tiendas) tiendas.style.display = 'block';
            if(panel) panel.style.display = 'none';
            
            const grid = document.getElementById('tiendas-grid');
            const lead = document.getElementById('productos-lead');
            if(grid && lead){
              lead.textContent = 'Inicia sesión para ver las tiendas disponibles en tu barrio.';
              grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--muted);"><p style="font-size: 1.1rem;">Por favor, inicia sesión para acceder a las tiendas disponibles en tu área.</p></div>';
            }
          }
        }

        // handle register (use email, password, role, barrio, direccion)
        const registerForm = document.getElementById('register-form');
        registerForm?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = (document.getElementById('reg-email')?.value || '').trim().toLowerCase();
          const password = document.getElementById('reg-pass')?.value || '';
          const role = document.getElementById('reg-role')?.value || '';
          const barrio = document.getElementById('reg-barrio')?.value || '';
          const direccion = (document.getElementById('reg-direccion')?.value || '').trim();
          if(!email || !password || !role || !barrio || !direccion){ alert('Completa todos los campos.'); return; }
          // simple email format check
          if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ alert('Introduce un correo válido.'); return; }
          const key = email;
          const users = loadUsers();
          if(users[key]){ alert('El correo ya está registrado. Usa otro.'); return; }
          if(password.length < 4){ if(!confirm('La contraseña es corta. ¿Continuar?')) return; }
          const hash = await hashPassword(password);
          users[key] = { email, passwordHash: hash, role, barrio, direccion, createdAt: new Date().toISOString() };
          saveUsers(users);
          // Si es fruver, agregar la tienda a la lista del barrio
          if(role === 'fruver'){
            const nombreTienda = `Fruver ${(email.split('@')[0]).charAt(0).toUpperCase() + (email.split('@')[0]).slice(1)}`;
            // Lista de imágenes disponibles en css/fruvers
            const imagenesDisponibles = [
              'css/fruvers/fruver1.jpg',
              'css/fruvers/fruver2.jpg',
              'css/fruvers/fruver3.jpg',
              'css/fruvers/fruver4.jpg',
              'css/fruvers/fruver5.jpg'
            ];
            const imagenAleatoria = imagenesDisponibles[Math.floor(Math.random() * imagenesDisponibles.length)];
            const nuevaTienda = {
              nombre: nombreTienda,
              descripcion: `Tienda de frutas y verduras en ${direccion}.`,
              imagen: imagenAleatoria
            };
            if(!TIENDAS_POR_BARRIO[barrio]){
              TIENDAS_POR_BARRIO[barrio] = [];
            }
            TIENDAS_POR_BARRIO[barrio].push(nuevaTienda);
            saveTiendas();
          }
          setCurrentUser(key);
          alert('Cuenta creada.');
          closeAuth();
        });

        // handle login (email + password)
        const loginForm = document.getElementById('login-form');
        loginForm?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = (document.getElementById('login-email')?.value || '').trim().toLowerCase();
          const password = document.getElementById('login-pass')?.value || '';
          if(!email || !password){ alert('Completa todos los campos.'); return; }
          const key = email;
          const users = loadUsers();
          const user = users[key];
          if(!user){ alert('Usuario no encontrado.'); return; }
          const hash = await hashPassword(password);
          if(hash !== user.passwordHash){ alert('Contraseña incorrecta.'); return; }
          setCurrentUser(key);
          closeAuth();
        });

        // Handle agregar producto para fruver
        const formProducto = document.getElementById('form-producto');
        formProducto?.addEventListener('submit', (e)=>{
          e.preventDefault();
          const cur = localStorage.getItem(SESSION_KEY);
          if(!cur) return;
          const nombre = (document.getElementById('prod-nombre')?.value || '').trim();
          const cantidad = parseInt(document.getElementById('prod-cantidad')?.value || '0');
          const precio = parseFloat(document.getElementById('prod-precio')?.value || '0');
          const imagenFile = document.getElementById('prod-imagen')?.files[0];
          if(!nombre || cantidad <= 0 || precio <= 0 || !imagenFile){ alert('Completa todos los campos correctamente.'); return; }
          
          const reader = new FileReader();
          reader.onload = (event)=>{
            const imagenBase64 = event.target.result;
            const PRODUCTOS_KEY = `campo_productos_${cur}`;
            let productos = [];
            try{
              productos = JSON.parse(localStorage.getItem(PRODUCTOS_KEY) || '[]');
            } catch(e){ }
            
            productos.push({ nombre, cantidad, precio, imagen: imagenBase64 });
            localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
            
            // Limpiar formulario
            formProducto.reset();
            // Actualizar lista
            renderFruverPanel(cur);
            alert('Producto agregado correctamente.');
          };
          reader.readAsDataURL(imagenFile);
        });

        // initialize UI state
        renderUserState();
      })();
    </script>
  </body>
</html>
