<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Campo Express</title>
    <link rel="stylesheet" href="css/styles.css">
  <!-- Favicon and manifest -->
  <link rel="apple-touch-icon" href="css/campoExpress.png">
  <link rel="icon" type="image/png" href="css/campoExpress.png">
  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#2F9E44">
  </head>
  <body>
    <!-- Navbar -->
    <header class="navbar">
        <div class="container nav-inner">
        <a class="brand" href="#">Campo Express</a>
        <nav class="nav-links">
          <a href="#nosotros">Nosotros</a>
          <a href="#modelo-de-negocio">Modelo de Negocio</a>
          <button class="btn btn-primary" id="btn-access">Acceder</button>
        </nav>
        <button class="nav-toggle" aria-label="Abrir menú">☰</button>
      </div>
    </header>

    <!-- Hero -->
    <section class="hero">
      <div class="container hero-inner">
        <div class="hero-text">
          <h1>Frutas y verduras frescas, directo a tu puerta</h1>
          <p>Seleccionamos lo mejor del día para que disfrutes productos frescos, locales y saludables.</p>
        </div>
        <div class="hero-visual">
          <img src="css/campoExpress.png" alt="Frutas y verduras frescas de Campo Express">
        </div>
      </div>
    </section>

    <!-- Productos -->
    <main class="container">
      <section id="productos" class="products">
        <h2>Nuestras Tiendas</h2>
        <p class="lead" id="productos-lead">Elige las tiendas mas cercanas</p>
        <div class="grid" id="tiendas-grid">
        </div>
      </section>

      <!-- Panel de productos para fruvers -->
      <section id="fruver-panel" class="products" style="display:none;">
        <h2>Mis Productos</h2>
        <div class="fruver-content">
          <div class="agregar-producto">
            <h3>Agregar nuevo producto</h3>
            <form id="form-producto">
              <div class="form-group">
                <label for="prod-nombre">Nombre del producto</label>
                <input id="prod-nombre" type="text" placeholder="Ej: Manzana roja" required>
              </div>
              <div class="form-group">
                <label for="prod-cantidad">Cantidad disponible</label>
                <input id="prod-cantidad" type="number" placeholder="Ej: 50" min="1" required>
              </div>
              <div class="form-group">
                <label for="prod-precio">Precio</label>
                <input id="prod-precio" type="number" placeholder="Ej: 2.50" step="0.01" min="0.01" required>
              </div>
              <div class="form-group">
                <label for="prod-unidad">Vender por</label>
                <select id="prod-unidad" required>
                  <option value="kg">Kilo (kg)</option>
                  <option value="unidad">Unidad</option>
                  <option value="libra">Libra</option>
                </select>
              </div>
              <div class="form-group">
                <label for="prod-imagen">Imagen del producto</label>
                <input id="prod-imagen" type="file" accept="image/*" required>
              </div>
              <button class="btn btn-primary" type="submit">Agregar producto</button>
            </form>
          </div>
          <div class="lista-productos">
            <h3>Productos disponibles</h3>
            <div id="productos-list" class="grid">
            </div>
          </div>
        </div>
      </section>

      <!-- Sección Nosotros -->
      <section id="nosotros" class="about">
        <h2>Nosotros</h2>
        <p>Campo Express es una plataforma que conecta fruvers con consumidores que buscan productos frescos y de calidad.</p>
      </section>

      <!-- Modelo de Negocio -->
      <section id="modelo-de-negocio" class="model">
        <h2>Modelo de Negocio</h2>
        <div class="model-inner">
          <img src="css/modeloCanvas.jpg" alt="Diagrama del modelo de negocio" class="zoomable">
        </div>
      </section>
    </main>

    <!-- Página separada: Detalle de tienda -->
    <div id="store-detail-page" style="display:none;position:fixed;top:80px;left:0;right:0;bottom:0;background:#f6fff5;z-index:80;overflow-y:auto;padding-right:0">
      <div class="container">
        <button id="store-detail-back" class="btn btn-outline" style="margin:1rem 0;">← Volver a tiendas</button>
        <h2 id="store-detail-title">Productos</h2>
        <p class="lead" id="store-detail-lead"></p>
        <div id="store-detail-grid" class="grid" style="margin:1rem 0 3rem"></div>
      </div>
      <!-- Footer en detalle de tienda -->
      <footer class="site-footer">
        <div class="container footer-inner">
          <div class="footer-col">
            <h3>Campo Express</h3>
            <p>Frutas y verduras frescas, seleccionadas con cariño.</p>
          </div>
          <div class="footer-col">
            <h4>Contacto</h4>
            <p>Email: contacto@campoexpress.com</p>
          </div>
        </div>
        <div class="footer-bottom">
          <div class="container">© 2025 Campo Express — </div>
        </div>
      </footer>
    </div>

    <!-- Sidebar Carrito (fijo) -->
    <aside id="cart-sidebar" style="display:none;position:fixed;right:0;top:80px;width:320px;height:calc(100vh-80px);background:white;border-left:1px solid rgba(11,43,24,0.08);box-shadow:-4px 0 12px rgba(0,0,0,0.08);z-index:85;overflow-y:auto;padding:1.5rem;flex-direction:column">
      <h3 style="margin:0 0 1rem;color:#10341e">Tu Carrito</h3>
      <div id="cart-items-list" style="flex:1;overflow-y:auto;margin-bottom:1rem"></div>
      <div id="cart-total" style="border-top:1px solid rgba(11,43,24,0.08);padding-top:0.75rem;margin-bottom:1rem;font-weight:600;color:var(--green)">Total: $0.00</div>
      <div style="display:flex;gap:0.5rem">
        <button id="cart-clear" class="btn btn-outline" style="flex:1;font-size:0.85rem">Vaciar</button>
        <button id="cart-checkout" class="btn btn-primary" style="flex:1;font-size:0.85rem">Comprar</button>
      </div>
    </aside>

    <!-- Footer -->
    <footer id="contacto" class="site-footer">
      <div class="container footer-inner">
        <div class="footer-col">
          <h3>Campo Express</h3>
          <p>Frutas y verduras frescas, seleccionadas con cariño.</p>
        </div>
        <div class="footer-col">
          <h4>Contacto</h4>
          <p>Email: contacto@campoexpress.com</p>
          
        </div>
      </div>
      <div class="footer-bottom">
        <div class="container">© 2025 Campo Express — </div>
      </div>
    </footer>

    <div class="image-modal" aria-hidden="true" role="dialog" aria-label="Imagen ampliada">
      <button class="image-modal__close" aria-label="Cerrar imagen">&times;</button>
      <img src="" alt="">
      <div class="close-hint">Presiona Esc o clic fuera para cerrar</div>
    </div>

    <!-- Modal de autenticación (login / registro) -->
    <div class="auth-modal" aria-hidden="true" role="dialog" aria-label="Autenticación">
      <div class="auth-panel" role="document">
        <button class="auth-close" aria-label="Cerrar">&times;</button>
        <div class="auth-tabs">
          <button class="auth-tab active" data-target="login">Iniciar sesión</button>
          <button class="auth-tab" data-target="register">Registrarse</button>
        </div>
        <div class="auth-body">
          <form id="login-form" class="auth-form active">
            <label for="login-email">Correo</label>
            <input id="login-email" name="email" type="email" required>
            <label for="login-pass">Contraseña</label>
            <input id="login-pass" name="password" type="password" required>
            <button class="btn btn-primary" type="submit">Entrar</button>
          </form>

          <form id="register-form" class="auth-form">
            <label for="reg-email">Correo</label>
            <input id="reg-email" name="email" type="email" required>
            <label for="reg-pass">Contraseña</label>
            <input id="reg-pass" name="password" type="password" required>
            <label for="reg-role">Rol</label>
            <select id="reg-role" name="role" required>
              <option value="">-- Selecciona rol --</option>
              <option value="fruver">Fruver</option>
              <option value="cliente">Cliente</option>
            </select>
            <label for="reg-barrio">Barrio</label>
            <select id="reg-barrio" name="barrio" required>
              <option value="">-- Selecciona barrio --</option>
              <option value="cabecera">Cabecera</option>
              <option value="provenza">Provenza</option>
              <option value="san-alonso">San Alonso</option>
            </select>
            <label for="reg-direccion">Dirección</label>
            <input id="reg-direccion" name="direccion" type="text" placeholder="Calle, número y referencias" required>
            <button class="btn btn-primary" type="submit">Crear cuenta</button>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Simple toggle para menú móvil
      const toggle = document.querySelector('.nav-toggle');
      const navLinks = document.querySelector('.nav-links');
      toggle?.addEventListener('click', ()=>{
        navLinks?.classList.toggle('open');
      });

      // Imagen zoomable -> modal fullscreen
      (function(){
        const zoomables = document.querySelectorAll('.zoomable');
        const modal = document.querySelector('.image-modal');
        if(!modal) return;
        const modalImg = modal.querySelector('img');
        const closeBtn = modal.querySelector('.image-modal__close');

        function openModal(src, alt){
          modalImg.src = src;
          modalImg.alt = alt || '';
          modal.classList.add('open');
          modal.setAttribute('aria-hidden','false');
          document.documentElement.classList.add('no-scroll');
          document.body.classList.add('no-scroll');
          closeBtn.focus();
        }

        function closeModal(){
          modal.classList.remove('open');
          modal.setAttribute('aria-hidden','true');
          modalImg.src = '';
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }

        zoomables.forEach(img=>{
          img.addEventListener('click', ()=>{
            openModal(img.getAttribute('src') || img.dataset.src, img.getAttribute('alt'));
          });
        });

        // Close on click outside image or on close button
        modal.addEventListener('click', (e)=>{
          if(e.target === modal || e.target === closeBtn) closeModal();
        });

        // Avoid closing when clicking the image itself
        modal.querySelector('img')?.addEventListener('click', (e)=>e.stopPropagation());

        // Close on Escape
        document.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape' && modal.classList.contains('open')) closeModal();
        });
      })();

      // Modal de autenticación (login / register)
      (function(){
        const accessBtn = document.getElementById('btn-access');
        const authModal = document.querySelector('.auth-modal');
        const authPanel = authModal?.querySelector('.auth-panel');
        const closeBtn = authModal?.querySelector('.auth-close');
        const tabs = authModal?.querySelectorAll('.auth-tab');
        const forms = authModal?.querySelectorAll('.auth-form');

        if(!accessBtn || !authModal) return;

        function openAuth(target){
          // show modal and select tab
          authModal.classList.add('open');
          authModal.setAttribute('aria-hidden','false');
          document.documentElement.classList.add('no-scroll');
          document.body.classList.add('no-scroll');
          // set tab
          selectTab(target || 'login');
          // focus first input
          setTimeout(()=>{
            const first = authModal.querySelector('.auth-form.active input');
            first?.focus();
          }, 50);
        }

        function closeAuth(){
          authModal.classList.remove('open');
          authModal.setAttribute('aria-hidden','true');
          document.documentElement.classList.remove('no-scroll');
          document.body.classList.remove('no-scroll');
        }

        function selectTab(name){
          tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===name));
          forms.forEach(f=>f.classList.toggle('active', f.id === (name==='login' ? 'login-form' : 'register-form')));
        }

        accessBtn.addEventListener('click', ()=>openAuth('login'));

        // tab clicks
        tabs.forEach(t=>t.addEventListener('click', ()=>selectTab(t.dataset.target)));

        // close handlers
        closeBtn?.addEventListener('click', closeAuth);
        authModal.addEventListener('click', (e)=>{ if(e.target === authModal) closeAuth(); });
        document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && authModal.classList.contains('open')) closeAuth(); });

        // Real auth logic (client-side demo using localStorage)
        const USERS_KEY = 'campo_users_v1';
        const SESSION_KEY = 'campo_current_user_v1';
        const TIENDAS_KEY = 'campo_tiendas_v1';

        // Base de datos de tiendas por barrio (inicial)
        let TIENDAS_POR_BARRIO = {
          'cabecera': [],
          'provenza': [],
          'san-alonso': []
        };

        function loadUsers(){
          try{ return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); }catch(e){ return {}; }
        }
        function saveUsers(obj){ localStorage.setItem(USERS_KEY, JSON.stringify(obj)); }

        function loadTiendas(){
          try{ 
            const stored = JSON.parse(localStorage.getItem(TIENDAS_KEY) || '{}');
            TIENDAS_POR_BARRIO = { ...TIENDAS_POR_BARRIO, ...stored };
          } catch(e){ }
        }

        function saveTiendas(){
          localStorage.setItem(TIENDAS_KEY, JSON.stringify(TIENDAS_POR_BARRIO));
        }

        // Cargar tiendas al inicializar
        loadTiendas();

        function renderTiendas(barrio){
          const grid = document.getElementById('tiendas-grid');
          const lead = document.getElementById('productos-lead');
          if(!grid) return;
          const tiendas = TIENDAS_POR_BARRIO[barrio] || [];
          if(tiendas.length > 0){
            lead.textContent = `Tiendas disponibles en ${barrio.charAt(0).toUpperCase() + barrio.slice(1)}`;
            grid.innerHTML = tiendas.map((t, idx)=>`
              <article class="card store-card" data-owner="${t.owner || t.email || ''}" data-idx="${idx}">
                <img src="${t.imagen}" alt="${t.nombre}">
                <div class="card-body">
                  <h3>${t.nombre}</h3>
                  <p>${t.descripcion}</p>
                  <div class="card-foot">
                    <span class="price">Tienda</span>
                  </div>
                </div>
              </article>
            `).join('');
            // attach click handlers to open store page
            setTimeout(()=>{
              grid.querySelectorAll('.store-card').forEach(card=>{
                card.style.cursor = 'pointer';
                card.addEventListener('click', ()=>{
                  const owner = card.dataset.owner;
                  const idx = parseInt(card.dataset.idx || '0', 10);
                  // open the dedicated store page (cliente view)
                  openStorePage(owner, barrio, idx);
                });
              });
            }, 50);
          } else {
            lead.textContent = 'No hay tiendas cercanas en tu barrio.';
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--muted);"><p>Lo sentimos, aún no tenemos tiendas disponibles en tu área. Pronto llegará a tu barrio.</p></div>';
          }
        }

        // Store page rendering and cart functions
        const CART_KEY = 'campo_cart_v1';

        function loadCart(){
          try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }catch(e){ return []; }
        }
        function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartBadge(); }
        function addToCart(item){
          const cart = loadCart();
          // try to find same product (same owner + nombre + unidad)
          const idx = cart.findIndex(c=> c.owner === item.owner && c.nombre === item.nombre && c.unidad === item.unidad);
          if(idx >= 0){ cart[idx].cantidad = parseFloat(cart[idx].cantidad) + parseFloat(item.cantidad); }
          else { cart.push(item); }
          saveCart(cart);
        }

        function updateCartBadge(){
          const sidebar = document.getElementById('cart-sidebar');
          const cart = loadCart();
          const total = cart.reduce((s,i)=> s + Number(i.cantidad || 0), 0);
          // show sidebar if cart has items AND user is logged in
          const cur = localStorage.getItem(SESSION_KEY);
          if(cur && sidebar){
            if(total > 0){ sidebar.style.display = 'flex'; }
            else{ sidebar.style.display = 'none'; }
          }
          // render cart items in sidebar
          renderCartSidebar();
        }

        function renderCartSidebar(){
          const list = document.getElementById('cart-items-list');
          const totalDiv = document.getElementById('cart-total');
          if(!list) return;
          const cart = loadCart();
          if(cart.length === 0){
            list.innerHTML = '<p style="text-align:center;color:var(--muted);font-size:0.9rem">Carrito vacío</p>';
            if(totalDiv) totalDiv.textContent = 'Total: $0.00';
            return;
          }
          let grandTotal = 0;
          list.innerHTML = cart.map((c,i)=>{
            const subtotal = parseFloat(c.precio) * parseFloat(c.cantidad);
            grandTotal += subtotal;
            return `
              <div style="padding:0.75rem;border-bottom:1px solid rgba(11,43,24,0.08);font-size:0.9rem">
                <div style="font-weight:600;margin-bottom:0.25rem">${c.nombre}</div>
                <div style="color:var(--muted);margin-bottom:0.25rem">${c.cantidad} ${c.unidad}</div>
                <div style="color:var(--green);margin-bottom:0.5rem">$${subtotal.toFixed(2)}</div>
                <button class="btn btn-outline" data-cart-remove="${i}" style="width:100%;padding:0.35rem;font-size:0.8rem">Quitar</button>
              </div>
            `;
          }).join('');
          if(totalDiv) totalDiv.textContent = `Total: $${grandTotal.toFixed(2)}`;
          // bind remove buttons
          list.querySelectorAll('[data-cart-remove]').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const i = parseInt(btn.dataset.cartRemove, 10);
              const cart = loadCart();
              cart.splice(i, 1);
              saveCart(cart);
            });
          });
        }

        function openStorePage(ownerEmail, barrio, idx){
          // show store detail page (full-screen overlay below navbar)
          const tiendas = TIENDAS_POR_BARRIO[barrio] || [];
          const tienda = tiendas[idx];
          const detailPage = document.getElementById('store-detail-page');
          if(detailPage) detailPage.style.display = 'block';
          const title = document.getElementById('store-detail-title');
          const lead = document.getElementById('store-detail-lead');
          const grid = document.getElementById('store-detail-grid');
          title.textContent = tienda?.nombre || 'Tienda';
          lead.textContent = tienda?.descripcion || '';
          // load products from owner
          const key = `campo_productos_${ownerEmail}`;
          let productos = [];
          try{ productos = JSON.parse(localStorage.getItem(key) || '[]'); } catch(e){ productos = []; }
          if(!grid) return;
          if(productos.length === 0){
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:1.5rem">Esta tienda no tiene productos disponibles.</div>';
          } else {
            grid.innerHTML = productos.map((p, pidx)=>{
              const qtyLabel = p.unidad === 'unidad' ? 'unidad(es)' : (p.unidad === 'libra' ? 'lb' : 'kg');
              return `
                <article class="card">
                  ${p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}">` : ''}
                  <div class="card-body">
                    <h3>${p.nombre}</h3>
                    <p><strong>Disponible:</strong> ${p.cantidad} ${qtyLabel}</p>
                    <p><strong>Precio:</strong> $${parseFloat(p.precio).toFixed(2)} / ${p.unidad || 'kg'}</p>
                    <div style="margin-top:0.75rem;display:flex;gap:0.5rem;align-items:center">
                      <input type="number" min="0.01" step="0.01" value="1" id="cart-qty-${pidx}" style="width:90px;padding:0.45rem;border-radius:8px;border:1px solid rgba(11,43,24,0.08)">
                      <button class="btn btn-primary" data-pidx="${pidx}" data-owner="${ownerEmail}">Agregar</button>
                    </div>
                  </div>
                </article>
              `;
            }).join('');
            // bind add to cart
            grid.querySelectorAll('.btn-primary').forEach(btn=>{
              btn.addEventListener('click', ()=>{
                const pidx = parseInt(btn.dataset.pidx,10);
                const owner = btn.dataset.owner;
                const prod = productos[pidx];
                const input = document.getElementById(`cart-qty-${pidx}`);
                const q = parseFloat(input?.value || '0');
                if(!prod || q <= 0){ alert('Introduce una cantidad válida.'); return; }
                const item = { owner, storeName: tienda?.nombre || '', nombre: prod.nombre, cantidad: q, unidad: prod.unidad || 'kg', precio: prod.precio, imagen: prod.imagen };
                addToCart(item);
                input.value = '1';
              });
            });
          }
          // back button
          const back = document.getElementById('store-detail-back');
          back?.addEventListener('click', ()=>{ closeStorePage(); });
        }

        function closeStorePage(){
          const detailPage = document.getElementById('store-detail-page');
          if(detailPage) detailPage.style.display = 'none';
        }

        // init cart badge
        updateCartBadge();
        // bind cart sidebar buttons
        const clearBtn = document.getElementById('cart-clear');
        const checkoutBtn = document.getElementById('cart-checkout');
        clearBtn?.addEventListener('click', ()=>{
          localStorage.setItem(CART_KEY, JSON.stringify([]));
          updateCartBadge();
          alert('Carrito vaciado.');
        });
        checkoutBtn?.addEventListener('click', ()=>{
          alert('Función de compra próximamente.');
        });

        async function hashPassword(password){
          const enc = new TextEncoder();
          const buf = await crypto.subtle.digest('SHA-256', enc.encode(password));
          return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
        }

        function setCurrentUser(key){
          localStorage.setItem(SESSION_KEY, key);
          const users = loadUsers();
          const user = users[key];
          if(user){
            if(user.role === 'fruver'){
              // Mostrar panel de fruver
              renderFruverPanel(key);
            } else if(user.barrio){
              // Mostrar tiendas para cliente
              renderTiendas(user.barrio);
            }
          }
          renderUserState();
        }

        function clearCurrentUser(){
          localStorage.removeItem(SESSION_KEY);
          renderUserState();
        }

        function renderFruverPanel(email){
          const tiendas = document.getElementById('productos');
          const panel = document.getElementById('fruver-panel');
          const tiendas_grid = document.getElementById('tiendas-grid');
          const productos_lead = document.getElementById('productos-lead');
          
          if(tiendas) tiendas.style.display = 'none';
          if(panel) panel.style.display = 'block';
          // ocultar secciones que no son necesarias para fruvers
          const nosotrosSection = document.getElementById('nosotros');
          const modeloSection = document.getElementById('modelo-de-negocio');
          if(nosotrosSection) nosotrosSection.style.display = 'none';
          if(modeloSection) modeloSection.style.display = 'none';
          
          // Cargar y mostrar productos del fruver
          const PRODUCTOS_KEY = `campo_productos_${email}`;
          let productos = [];
          try{
            productos = JSON.parse(localStorage.getItem(PRODUCTOS_KEY) || '[]');
          } catch(e){ }
          
          const productosLista = document.getElementById('productos-list');
          if(productosLista){
            if(productos.length === 0){
              productosLista.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--muted);">No tienes productos aún. Agrega uno nuevo.</p>';
            } else {
              productosLista.innerHTML = productos.map((p, idx)=>{
                const unidad = p.unidad || 'kg';
                const unitLabel = unidad === 'unidad' ? 'unidad' : (unidad === 'libra' ? 'libra' : 'kg');
                const qtyLabel = unidad === 'unidad' ? 'unidad(es)' : (unidad === 'libra' ? 'lb' : 'kg');
                return `
                <article class="card">
                  ${p.imagen ? `<img src="${p.imagen}" alt="${p.nombre}" style="width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius);">` : ''}
                  <div class="card-body">
                    <h3>${p.nombre}</h3>
                    <p><strong>Cantidad:</strong> ${p.cantidad} ${qtyLabel}</p>
                    <p><strong>Precio:</strong> $${parseFloat(p.precio).toFixed(2)} / ${unitLabel}</p>
                    <div class="card-foot">
                      <button class="btn btn-outline btn-delete" data-idx="${idx}">Eliminar</button>
                    </div>
                  </div>
                </article>
              `;
              }).join('');
              // Agregar event listeners para eliminar
              productosLista.querySelectorAll('.btn-delete').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                  const idx = parseInt(btn.dataset.idx);
                  productos.splice(idx, 1);
                  localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
                  renderFruverPanel(email);
                });
              });
            }
          }
        }

        function clearCurrentUser(){
          localStorage.removeItem(SESSION_KEY);
          renderUserState();
        }

        function renderUserState(){
          const cur = localStorage.getItem(SESSION_KEY);
          const nav = document.querySelector('.nav-links');
          if(!nav) return;
          // remove existing user UI
          const existingLogout = document.getElementById('btn-logout');
          const existingUser = document.querySelector('.nav-user');
          if(existingLogout) existingLogout.remove();
          if(existingUser) existingUser.remove();
          // ensure access button exists
          let access = document.getElementById('btn-access');
          if(!access){
            access = document.createElement('button');
            access.className = 'btn btn-primary';
            access.id = 'btn-access';
            access.textContent = 'Acceder';
            nav.appendChild(access);
            access.addEventListener('click', ()=>openAuth('login'));
          }

          if(cur){
            const users = loadUsers();
            const user = users[cur];
            if(user){
              // replace access with greeting + logout
              access.remove();
              const span = document.createElement('span');
              span.className = 'nav-user';
              // helper: capitalize first letter (safe for empty values)
              const cap = (s) => { if(!s) return ''; return String(s).charAt(0).toUpperCase() + String(s).slice(1); };
              const display = cap((user.email || '').split('@')[0] || user.email);
              const barrioCap = cap(user.barrio || '');
              const direccionCap = cap(user.direccion || '');
              const direccionText = user.direccion ? ` - ${barrioCap} - ${direccionCap}` : '';
              span.textContent = `Hola, ${display}${direccionText}`;
              nav.appendChild(span);
              const out = document.createElement('button');
              out.className = 'btn btn-outline';
              out.id = 'btn-logout';
              out.textContent = 'Cerrar sesión';
              nav.appendChild(out);
              out.addEventListener('click', ()=>{ clearCurrentUser(); });

              // mostrar/ocultar secciones según rol
              const nosotrosSection = document.getElementById('nosotros');
              const modeloSection = document.getElementById('modelo-de-negocio');
              if(user.role === 'fruver'){
                if(nosotrosSection) nosotrosSection.style.display = 'none';
                if(modeloSection) modeloSection.style.display = 'none';
              } else {
                // cliente u otros: asegurarse de que las secciones sean visibles
                if(nosotrosSection) nosotrosSection.style.display = '';
                if(modeloSection) modeloSection.style.display = '';
              }
            }
          } else {
            // Sin sesión: mostrar mensaje en productos y ocultar panel fruver
            const tiendas = document.getElementById('productos');
            const panel = document.getElementById('fruver-panel');
            if(tiendas) tiendas.style.display = 'block';
            if(panel) panel.style.display = 'none';
            // ocultar carrito cuando se cierra sesión
            const cartSidebar = document.getElementById('cart-sidebar');
            if(cartSidebar) cartSidebar.style.display = 'none';
            // Asegurar que se muestren las secciones públicas cuando no hay sesión
            const nosotrosSection = document.getElementById('nosotros');
            const modeloSection = document.getElementById('modelo-de-negocio');
            if(nosotrosSection) nosotrosSection.style.display = '';
            if(modeloSection) modeloSection.style.display = '';
            const grid = document.getElementById('tiendas-grid');
            const lead = document.getElementById('productos-lead');
            if(grid && lead){
              lead.textContent = 'Inicia sesión para ver las tiendas disponibles en tu barrio.';
              grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--muted);"><p style="font-size: 1.1rem;">Por favor, inicia sesión para acceder a las tiendas disponibles en tu área.</p></div>';
            }
          }
        }

        // handle register (use email, password, role, barrio, direccion)
        const registerForm = document.getElementById('register-form');
        registerForm?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = (document.getElementById('reg-email')?.value || '').trim().toLowerCase();
          const password = document.getElementById('reg-pass')?.value || '';
          const role = document.getElementById('reg-role')?.value || '';
          const barrio = document.getElementById('reg-barrio')?.value || '';
          const direccion = (document.getElementById('reg-direccion')?.value || '').trim();
          if(!email || !password || !role || !barrio || !direccion){ alert('Completa todos los campos.'); return; }
          // simple email format check
          if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){ alert('Introduce un correo válido.'); return; }
          const key = email;
          const users = loadUsers();
          if(users[key]){ alert('El correo ya está registrado. Usa otro.'); return; }
          if(password.length < 4){ if(!confirm('La contraseña es corta. ¿Continuar?')) return; }
          const hash = await hashPassword(password);
          users[key] = { email, passwordHash: hash, role, barrio, direccion, createdAt: new Date().toISOString() };
          saveUsers(users);
          // Si es fruver, agregar la tienda a la lista del barrio
          if(role === 'fruver'){
            const nombreTienda = `Fruver ${(email.split('@')[0]).charAt(0).toUpperCase() + (email.split('@')[0]).slice(1)}`;
            // Lista de imágenes disponibles en css/fruvers
            const imagenesDisponibles = [
              'css/fruvers/fruver1.jpg',
              'css/fruvers/fruver2.jpg',
              'css/fruvers/fruver3.jpg',
              'css/fruvers/fruver4.jpg',
              'css/fruvers/fruver5.jpg'
            ];
            const imagenAleatoria = imagenesDisponibles[Math.floor(Math.random() * imagenesDisponibles.length)];
            const nuevaTienda = {
              nombre: nombreTienda,
              descripcion: `Tienda de frutas y verduras en ${direccion}.`,
              imagen: imagenAleatoria,
              owner: email
            };
            if(!TIENDAS_POR_BARRIO[barrio]){
              TIENDAS_POR_BARRIO[barrio] = [];
            }
            TIENDAS_POR_BARRIO[barrio].push(nuevaTienda);
            saveTiendas();
          }
          setCurrentUser(key);
          alert('Cuenta creada.');
          closeAuth();
        });

        // handle login (email + password)
        const loginForm = document.getElementById('login-form');
        loginForm?.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const email = (document.getElementById('login-email')?.value || '').trim().toLowerCase();
          const password = document.getElementById('login-pass')?.value || '';
          if(!email || !password){ alert('Completa todos los campos.'); return; }
          const key = email;
          const users = loadUsers();
          const user = users[key];
          if(!user){ alert('Usuario no encontrado.'); return; }
          const hash = await hashPassword(password);
          if(hash !== user.passwordHash){ alert('Contraseña incorrecta.'); return; }
          setCurrentUser(key);
          closeAuth();
        });

        // Handle agregar producto para fruver
        const formProducto = document.getElementById('form-producto');
        formProducto?.addEventListener('submit', (e)=>{
          e.preventDefault();
          const cur = localStorage.getItem(SESSION_KEY);
          if(!cur) return;
          const nombre = (document.getElementById('prod-nombre')?.value || '').trim();
          const cantidad = parseInt(document.getElementById('prod-cantidad')?.value || '0');
          const precio = parseFloat(document.getElementById('prod-precio')?.value || '0');
          const unidad = (document.getElementById('prod-unidad')?.value || 'kg');
          const imagenFile = document.getElementById('prod-imagen')?.files[0];
          if(!nombre || cantidad <= 0 || precio <= 0 || !imagenFile || !unidad){ alert('Completa todos los campos correctamente.'); return; }
          
          const reader = new FileReader();
          reader.onload = (event)=>{
            const imagenBase64 = event.target.result;
            const PRODUCTOS_KEY = `campo_productos_${cur}`;
            let productos = [];
            try{
              productos = JSON.parse(localStorage.getItem(PRODUCTOS_KEY) || '[]');
            } catch(e){ }
            
            productos.push({ nombre, cantidad, precio, unidad, imagen: imagenBase64 });
            localStorage.setItem(PRODUCTOS_KEY, JSON.stringify(productos));
            
            // Limpiar formulario
            formProducto.reset();
            // Actualizar lista
            renderFruverPanel(cur);
            alert('Producto agregado correctamente.');
          };
          reader.readAsDataURL(imagenFile);
        });

        // initialize UI state
        renderUserState();
      })();
    </script>
  </body>
</html>
